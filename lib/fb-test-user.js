// Generated by CoffeeScript 1.6.3
var FacebookTestUser, request;

request = require('request');

FacebookTestUser = (function() {
  FacebookTestUser.URL = 'https://graph.facebook.com';

  function FacebookTestUser(config) {
    this.config = config;
    this.testUser = null;
  }

  FacebookTestUser.prototype.getAccessToken = function(cb) {
    var url;
    url = "" + FacebookTestUser.URL + "/oauth/access_token?client_id=" + this.config.appId + "&client_secret=" + this.config.appSecret + "&grant_type=client_credentials";
    return request(url, function(err, res, token) {
      return cb(err, token);
    });
  };

  FacebookTestUser.prototype.getTestUsers = function(token, cb) {
    var url;
    url = "" + FacebookTestUser.URL + "/" + this.config.appId + "/accounts/test-users?" + token;
    return request(url, function(err, res, body) {
      if (err) {
        return cb(err);
      }
      body = JSON.parse(body);
      return cb(null, body.data);
    });
  };

  FacebookTestUser.prototype.createTestUser = function(token, cb) {
    var url;
    url = "" + FacebookTestUser.URL + "/" + this.config.appId + "/accounts/test-users?permissions=" + this.config.permissions + "&method=post&" + token;
    return request(url, function(err, res, body) {
      if (err) {
        return done(err);
      }
      return cb(null, JSON.parse(body));
    });
  };

  FacebookTestUser.prototype.getTestUser = function(cb) {
    var _this = this;
    if (this.testUser !== null) {
      return cb(null, this.testUser);
    }
    return this.getAccessToken(function(err, token) {
      if (err) {
        return cb(err);
      }
      return _this.getTestUsers(token, function(err, users) {
        if (err) {
          return cb(err);
        }
        if (users.length) {
          _this.testUser = users[0];
          return cb(null, _this.testUser);
        } else {
          return _this.createTestUser(token, function(err, user) {
            if (err) {
              return cb(err);
            }
            this.testUser = user;
            return cb(null, this.testUser);
          });
        }
      });
    });
  };

  return FacebookTestUser;

})();

exports.module = FacebookTestUser;
